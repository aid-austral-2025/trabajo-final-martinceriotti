---
title: "Trabajo Final"
format: html
lang: es
author:
  name: "Mart√≠n Ceriotti"
  affiliation: "Universidad Austral"
editor: visual
toc: true
toc-location: left
toc-title: "Tabla de contenidos"
html:
    embed-resources: true
---

## Trabajo Pr√°ctico Final de An√°lisis Inteligente de Datos.

Como hijo de productores agropecuarios, siempre estuve relacionado con la producci√≥n de distintos cultivos en la regi√≥n central de la provincia de Santa Fe. Desde peque√±o he visto como las distintas "variables" afectaban tanto la producci√≥n como el humor familiar.

El an√°lisis que voy a realizar, es sobre la producci√≥n de soja, ma√≠z y trigo en la Rep√∫blica Argentina. Estos datos fueron descargados del sitio web de la Secretar√≠a de Agricultura , Ganader√≠a y Pesca [https://datos.magyp.gob.ar](https://datos.magyp.gob.ar/) "Secretar√≠a de Agricultura , Ganader√≠a y Pesca de la Rep√∫blica Argentina")

## Descripci√≥n de los datos {#sec-descripci√≥n-de-los-datos}

| T√≠tulo de la columna | Tipo de dato | Descripci√≥n |
|------------------------|------------------------|------------------------|
| cultivo_nombre¬† | Texto (string) | Nombre del cultivo.¬† |
| anio¬† | N√∫mero entero (integer) | A√±o al que corresponden los datos.¬† |
| campania¬† | Texto (string) | Campa√±a en la que se desarrollo el cultivo.¬† |
| provincia_nombre | Texto (string) | Nombre de la provincia.¬† |
| provincia_id¬† | Texto (string) | C√≥digo de la provincia.¬† |
| departamento_nombre¬† | Texto (string) | Nombre del departamento.¬† |
| departamento_id¬† | Texto (string) | C√≥digo del departamento.¬† |
| superficie_sembrada_ha | N√∫mero entero (integer) | Superficie sembrada en hect√°reas.¬† |
| superficie_cosechada_ha | N√∫mero entero (integer) | Superficie cosechada en hect√°reas.¬† |
| produccion_tm¬† | N√∫mero entero (integer) | Producci√≥n en toneladas.¬† |
| rendimiento_kgxha | N√∫mero entero (integer) | Rendimiento en kilos por hect√°rea.¬† |

```{r}
#| message: false
#| warning: false
#| include: false
#| paged-print: false
library(tidyverse)
library(pastecs)
library(kableExtra)
maiz_serie_1923_2023 <- read_csv("data/maiz-serie-1923-2023.csv", 
                                 col_types = cols(anio = col_integer()), 
                                 locale = locale(encoding = "latin1"))

soja_serie_1941_2023 <- read_csv("data/soja-serie-1941-2023.csv", 
                                 col_types = cols(anio = col_integer()), 
                                 locale = locale(encoding = "UTF-8"))

trigo_serie_1927_2024 <- read_csv("data/trigo-serie-1927-2024.csv", 
                                  col_types = cols(anio = col_integer()), 
                                  locale = locale(encoding = "latin1"))
# Filtramos 1947 / 2023 para tener todos los cultivos todos los a√±os y poder hacer otros an√°lisis.
datos <- bind_rows(maiz_serie_1923_2023,soja_serie_1941_2023, trigo_serie_1927_2024) |> 
  filter(anio >= 1947 & anio <= 2023)

#Par√°metros para todos los ggplots.

theme_set(theme_light())
options(repr.plot.width=15, repr.plot.height=8)

# Evoluci√≥n de las hectareas sembradas de cada cultivo.

```

## An√°lisis Gr√°fico y Descriptivo Preliminar

```{r}
#| echo: false
res <- datos |> 
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm,	rendimiento_kgxha) |> 
  pastecs::stat.desc() %>%
  as.matrix() %>%
  as.data.frame() %>%
  round(2)
res <- format(res, digits = 2, nsmall = 2, scientific = FALSE)
rownames(res) <- c(
  "N¬∞ de valores",
  "N¬∞ de ceros",
  "N¬∞ de NA",
  "M√≠nimo",
  "M√°ximo",
  "Rango",
  "Suma",
  "Mediana",
  "Media",
  "Error est√°ndar de la media",
  "IC 95% de la media",
  "Varianza",
  "Desviaci√≥n est√°ndar",
  "Coeficiente de variaci√≥n"
)

knitr::kable(data.frame(res),digits = 2)

```

### Correlaciones

Es de esperar que a las medidas est√©n correlacionadas dado que a mayor superficie sembrada se espera mayor produccion. La √∫nica que no est√° correlacionada es el rendimiento por ha.

```{r}
#| echo: false
#| message: false
#| warning: false
library("psych")
datos |>
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm, rendimiento_kgxha) |>
  pairs.panels(
    method = "pearson", # correlation method
    hist.col = "#00AFBB",
    density = TRUE, # show density plots
    ellipses = F # show correlation ellipses
  )
```

### BoxPlot

Hay gran variabilidad en los datos, ya que hay muchos departamentos de variado tama√±o, con superficies y rindes de todo tipo.

```{r}
#| echo: false
#| message: false
#| warning: false
 

dfInd<-
  datos |>
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm, rendimiento_kgxha) |> 
stack( )
names(dfInd)<-c("valor","variable")
ggplot(dfInd, aes(x = variable, y = valor)) +
geom_boxplot()
```

## Gr√°ficos

### Evoluci√≥n de la siembra de los cultivos desde 1947 a 2023.

```{r}
#| label: grafico 1
#| echo: false
#| message: false
#| warning: false
#| paged-print: false

library(ggrepel)
datos |>
  group_by(anio, cultivo_nombre) |>
  summarise(superficie_sembrada_ha_total = sum(superficie_sembrada_ha)) |>
  ggplot() +
  aes(x = anio, y = superficie_sembrada_ha_total / 1000000, colour = factor(cultivo_nombre)) +
  geom_line(size = 0.9) +
  geom_vline(
    aes(xintercept = 1970, linetype = "Comienzo Siembra directa\nFuente: AAPRESID"),
    lwd = 0.9, lineend = "round", col = "orange"
  ) + # Comienza la siembra directa
  geom_vline(
    aes(xintercept = 2008, linetype = "Conflicto con\nel campo"),
    lwd = 0.9, lineend = "round",
  ) + # Comienza la siembra directa
    labs(x = 'A√±o', y = 'Superficie Sembrada en millones de ha.', color = "Cultivos", title = "Gr√°fico 1: Evoluci√≥n de la superficie sembrada.", subtitle = "En millones de hect√°reas") +
  scale_colour_brewer(palette = "Dark2") +
  geom_text_repel(
    data = \(d) d |>
      group_by(cultivo_nombre) |>
      filter(anio == max(anio)),
    aes(label = cultivo_nombre),
    nudge_x = 1.5, # desplaza un poco a la derecha del √∫ltimo punto
    direction = "y",
    hjust = 0,
    segment.color = NA, # sin l√≠neas de uni√≥n
    size = 3
  ) + # nombre al final de las lineas
  theme(legend.position = "none")



```

::: {.callout-note appearance="simple"}
**1970:** Comienzo de la siembra directa en Argentina (fuente: Aapresid - Asociaci√≥n Argentina de Productores en Siembra Directa).

**2008:** Inicio del conflicto entre el gobierno nacional y los productores agropecuarios.
:::

En el Gr√°fico 1 se aprecia el crecimiento exponencial a partir de 1970 de la superficie sembrada con soja, cuando se comenz√≥ a utilizar la siembra directa ‚Äî una t√©cnica que consiste en sembrar directamente sobre el rastrojo del cultivo anterior, sin labrar previamente el suelo.

En 2008, dicho crecimiento se detiene. El conflicto del campo fue una profunda disputa entre el gobierno nacional y el sector agropecuario, originada por la Resoluci√≥n 125/2008, que establec√≠a un sistema de retenciones m√≥viles a las exportaciones de granos, especialmente soja.

En el caso del trigo, la serie se mantiene relativamente estable. Para el ma√≠z podemos notar que en 2008, se comienza a elegir este cultivo con menos retenciones en lugar de la soja.

### Superficie hist√≥rica sembrada por provincia y cultivo.

```{r}
#| echo: false
#| message: false
#| warning: false
#| paged-print: false

# Producci√≥n por Provincia.

datos |>
  group_by(provincia_nombre, cultivo_nombre) |>
  summarise(superficie_sembrada_ha = sum(superficie_sembrada_ha)) |>
  ggplot() +
  labs(y = 'Provincia', x = 'Superficie Sembrada en millones de ha.', color = "Cultivos", title = "Gr√°fico 2: Superficie sembrada por provincia.", subtitle = "En millones de hect√°reas") +
  aes(
    x = superficie_sembrada_ha / 1000000,
    y = reorder(provincia_nombre, superficie_sembrada_ha),
    fill = cultivo_nombre
  ) +
  geom_bar(stat = "identity") +
  facet_wrap(~cultivo_nombre) +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = "none") 
```

Las provincias de mayor producci√≥n de los cultivos en estudio son Buenos Aires, C√≥rdoba, Santa Fe, Entre R√≠os y La Pampa.

### Mejores Rindos Hist√≥ricos por Provincias y Departamentos.

```{r}
#| echo: false
#| message: false
#| warning: false
library(htmltools)
res <- datos |> 
  group_by(anio, provincia_nombre, departamento_nombre, cultivo_nombre) |> 
     summarise(rendimiento_kgxha = max(rendimiento_kgxha, na.rm = TRUE)) |> 
  ungroup() |>
  arrange(desc(rendimiento_kgxha)) |>
  slice_head(n = 10) 

knitr::kable(data.frame(res),digits = 2)
```
### Mejores Campa√±as de la historia.

```{r}
#| echo: false
#| message: false
#| warning: false
library(htmltools)
res <- datos |> 
  group_by(campania) |> 
     summarise(produccion_tm = sum(produccion_tm, na.rm = TRUE)) |> 
  ungroup() |>
  arrange(desc(produccion_tm)) |>
  slice_head(n = 10) 

knitr::kable(data.frame(res),digits = 2)
```
```{r}
#| echo: false
#| message: false
#| warning: false

# datos |>
#   ggplot(aes(x = superficie_sembrada_ha, y = superficie_cosechada_ha)) +
#   geom_point(alpha = 0.6, color = "#00AFBB") +
#   labs(
#     title = "Relaci√≥n entre superficie sembrada y cosechada",
#     x = "Superficie sembrada (ha)",
#     y = "Superficie cosechada (ha)"
#   ) +
#   theme_minimal()
# datos |>
#   ggplot(aes(
#     x = superficie_sembrada_ha,
#     y = superficie_cosechada_ha,
#     size = produccion_tm     # <--- tama√±o de la burbuja
#   )) +
#   geom_point(alpha = 0.6, color = "#00AFBB") +
#   labs(
#     title = "Relaci√≥n entre superficie y producci√≥n",
#     x = "Superficie sembrada (ha)",
#     y = "Superficie cosechada (ha)",
#     size = "Producci√≥n (toneladas)"
#   ) +
#   theme_minimal()
library(ggplot2)
library(gganimate)
library(dplyr)

animacion <- datos |>
  ggplot(aes(
    x = superficie_sembrada_ha,
    y = superficie_cosechada_ha,
    size = produccion_tm,
    color = cultivo_nombre
  )) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(2, 12)) +
  labs(
    title = "Evoluci√≥n de superficies y producci√≥n ({closest_state})",
    subtitle = "A√±o: {closest_state}",
    x = "Superficie sembrada (ha)",
    y = "Superficie cosechada (ha)",
    size = "Producci√≥n (t)",
    color = "Cultivo"
  ) +
  theme_minimal() +
  # üëá Esta l√≠nea hace la magia:
  transition_states(anio, transition_length = 1, state_length = 1) 
animacion
```
