---
title: "Trabajo Final"
format: html
lang: es
author:
  name: "Martín Ceriotti"
  affiliation: "Universidad Austral"
editor: visual
toc: true
toc-location: left
toc-title: "Tabla de contenidos"
html:
    embed-resources: true
---

## Trabajo Práctico Final de Análisis Inteligente de Datos.

Como hijo de productores agropecuarios, siempre estuve relacionado con la producción de distintos cultivos en la región central de la provincia de Santa Fe. Desde pequeño he visto como las distintas "variables" afectaban tanto la producción como el humor familiar.

El análisis que voy a realizar, es sobre la producción de soja, maíz y trigo en la República Argentina. Estos datos fueron descargados del sitio web de la Secretaría de Agricultura , Ganadería y Pesca [https://datos.magyp.gob.ar](https://datos.magyp.gob.ar/) "Secretaría de Agricultura , Ganadería y Pesca de la República Argentina")

## Descripción de los datos {#sec-descripción-de-los-datos}

| Título de la columna | Tipo de dato | Descripción |
|------------------------|------------------------|------------------------|
| cultivo_nombre  | Texto (string) | Nombre del cultivo.  |
| anio  | Número entero (integer) | Año al que corresponden los datos.  |
| campania  | Texto (string) | Campaña en la que se desarrollo el cultivo.  |
| provincia_nombre | Texto (string) | Nombre de la provincia.  |
| provincia_id  | Texto (string) | Código de la provincia.  |
| departamento_nombre  | Texto (string) | Nombre del departamento.  |
| departamento_id  | Texto (string) | Código del departamento.  |
| superficie_sembrada_ha | Número entero (integer) | Superficie sembrada en hectáreas.  |
| superficie_cosechada_ha | Número entero (integer) | Superficie cosechada en hectáreas.  |
| produccion_tm  | Número entero (integer) | Producción en toneladas.  |
| rendimiento_kgxha | Número entero (integer) | Rendimiento en kilos por hectárea.  |

```{r}
#| message: false
#| warning: false
#| include: false
#| paged-print: false
library(tidyverse)
library(pastecs)
library(kableExtra)
library(plotly)
maiz_serie_1923_2023 <- read_csv("data/maiz-serie-1923-2023.csv",
  col_types = cols(anio = col_integer()),
  locale = locale(encoding = "latin1")
)

soja_serie_1941_2023 <- read_csv("data/soja-serie-1941-2023.csv",
  col_types = cols(anio = col_integer()),
  locale = locale(encoding = "UTF-8")
)

trigo_serie_1927_2024 <- read_csv("data/trigo-serie-1927-2024.csv",
  col_types = cols(anio = col_integer()),
  locale = locale(encoding = "latin1")
)
# Filtramos 1947 / 2023 para tener todos los cultivos todos los años y poder hacer otros análisis.
datos <- bind_rows(maiz_serie_1923_2023, soja_serie_1941_2023, trigo_serie_1927_2024) |>
  filter(anio >= 1947 & anio <= 2023)

# Parámetros para todos los ggplots.

theme_set(theme_light())
options(repr.plot.width = 15, repr.plot.height = 8)

# Evolución de las hectareas sembradas de cada cultivo.
```

## Análisis Gráfico y Descriptivo Preliminar

```{r}
#| echo: false
res <- datos |>
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm, rendimiento_kgxha) |>
  pastecs::stat.desc() %>%
  as.matrix() %>%
  as.data.frame() %>%
  round(2)
res <- format(res, digits = 2, nsmall = 2, scientific = FALSE)
rownames(res) <- c(
  "N° de valores",
  "N° de ceros",
  "N° de NA",
  "Mínimo",
  "Máximo",
  "Rango",
  "Suma",
  "Mediana",
  "Media",
  "Error estándar de la media",
  "IC 95% de la media",
  "Varianza",
  "Desviación estándar",
  "Coeficiente de variación"
)

knitr::kable(data.frame(res), digits = 2)
```

### Correlaciones

Es de esperar que a las medidas estén correlacionadas dado que a mayor superficie sembrada se espera mayor produccion. La única que no está correlacionada es el rendimiento por ha.

```{r}
#| echo: false
#| message: false
#| warning: false
library("psych")
datos |>
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm, rendimiento_kgxha) |>
  pairs.panels(
    method = "pearson", # correlation method
    hist.col = "#00AFBB",
    density = TRUE, # show density plots
    ellipses = F # show correlation ellipses
  )
```

### BoxPlot

Hay gran variabilidad en los datos, ya que hay muchos departamentos de variado tamaño, con superficies y rindes de todo tipo.

```{r}
#| echo: false
#| message: false
#| warning: false


dfInd <-
  datos |>
  select(superficie_sembrada_ha, superficie_cosechada_ha, produccion_tm, rendimiento_kgxha) |>
  stack()
names(dfInd) <- c("valor", "variable")
ggplot(dfInd, aes(x = variable, y = valor)) +
  geom_boxplot()
```

## Gráficos

### Evolución de la siembra de los cultivos desde 1947 a 2023.

```{r}
#| label: grafico 1
#| echo: false
#| message: false
#| warning: false
#| paged-print: false

library(ggrepel)
datos |>
  group_by(anio, cultivo_nombre) |>
  summarise(superficie_sembrada_ha_total = sum(superficie_sembrada_ha)) |>
  ggplot() +
  aes(x = anio, y = superficie_sembrada_ha_total / 1000000, colour = factor(cultivo_nombre)) +
  geom_line(size = 0.9) +
  geom_vline(
    aes(xintercept = 1970, linetype = "Comienzo Siembra directa\nFuente: AAPRESID"),
    lwd = 0.9, lineend = "round", col = "orange"
  ) + # Comienza la siembra directa
  geom_vline(
    aes(xintercept = 2008, linetype = "Conflicto con\nel campo"),
    lwd = 0.9, lineend = "round",
  ) + # Comienza la siembra directa
  labs(x = "Año", y = "Superficie Sembrada en millones de ha.", color = "Cultivos", title = "Gráfico 1: Evolución de la superficie sembrada.", subtitle = "En millones de hectáreas") +
  scale_colour_brewer(palette = "Dark2") +
  geom_text_repel(
    data = \(d) d |>
      group_by(cultivo_nombre) |>
      filter(anio == max(anio)),
    aes(label = cultivo_nombre),
    nudge_x = 1.5, # desplaza un poco a la derecha del último punto
    direction = "y",
    hjust = 0,
    segment.color = NA, # sin líneas de unión
    size = 3
  ) + # nombre al final de las lineas
  theme(legend.position = "none")
```

::: {.callout-note appearance="simple"}
**1970:** Comienzo de la siembra directa en Argentina (fuente: Aapresid - Asociación Argentina de Productores en Siembra Directa).

**2008:** Inicio del conflicto entre el gobierno nacional y los productores agropecuarios.
:::

En el Gráfico 1 se aprecia el crecimiento exponencial a partir de 1970 de la superficie sembrada con soja, cuando se comenzó a utilizar la siembra directa — una técnica que consiste en sembrar directamente sobre el rastrojo del cultivo anterior, sin labrar previamente el suelo.

En 2008, dicho crecimiento se detiene. El conflicto del campo fue una profunda disputa entre el gobierno nacional y el sector agropecuario, originada por la Resolución 125/2008, que establecía un sistema de retenciones móviles a las exportaciones de granos, especialmente soja.

En el caso del trigo, la serie se mantiene relativamente estable. Para el maíz podemos notar que en 2008, se comienza a elegir este cultivo con menos retenciones en lugar de la soja.

### Superficie histórica sembrada por provincia y cultivo.

```{r}
#| echo: false
#| message: false
#| warning: false
#| paged-print: false

# Producción por Provincia.

datos |>
  group_by(provincia_nombre, cultivo_nombre) |>
  summarise(superficie_sembrada_ha = sum(superficie_sembrada_ha)) |>
  ggplot() +
  labs(y = "Provincia", 
       x = "Superficie Sembrada en millones de ha.", 
       color = "Cultivos", 
       title = "Gráfico 2: Superficie sembrada por provincia.", 
       subtitle = "En millones de hectáreas") +
  aes(
    x = superficie_sembrada_ha / 1000000,
    y = reorder(provincia_nombre, superficie_sembrada_ha),
    fill = cultivo_nombre
  ) +
  geom_bar(stat = "identity") +
  facet_wrap(~cultivo_nombre) +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = "none")
```

Las provincias de mayor producción de los cultivos en estudio son Buenos Aires, Córdoba, Santa Fe, Entre Ríos y La Pampa.

### Mejores Rindes Históricos.

```{r}
#| echo: false
#| message: false
#| warning: false
library(htmltools)
res <- datos |>
  group_by(anio, provincia_nombre, departamento_nombre, cultivo_nombre) |>
  summarise(rendimiento_kgxha = max(rendimiento_kgxha, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(rendimiento_kgxha)) |>
  slice_head(n = 10)

knitr::kable(data.frame(res), digits = 2)
```
::: {.callout-note appearance="simple"}
**Rendimientos en Maíz** De acuerdo al *Récord mundial Guinness*, el rendimiento máximo histórico de maíz, se dió en Virginia, EE. UU. en el año 2023. El rendimiento fue alrededor de 38 toneladas por hectárea. Dicho esto, es probable que los datos históricos que se tienen para Maiz deban ser revisados.
:::
### Mejores Campañas de la historia.

```{r}
#| echo: false
#| message: false
#| warning: false
library(htmltools)
res <- datos |>
  group_by(campania) |>
  summarise(produccion_tm = sum(produccion_tm, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(produccion_tm)) |>
  slice_head(n = 10)

knitr::kable(data.frame(res), digits = 2)
```
### Evolución Superficie Sembrada Vs. Cosechada.
```{r}
#| echo: false
#| message: false
#| warning: false

# datos |>
#   ggplot(aes(x = superficie_sembrada_ha, y = superficie_cosechada_ha)) +
#   geom_point(alpha = 0.6, color = "#00AFBB") +
#   labs(
#     title = "Relación entre superficie sembrada y cosechada",
#     x = "Superficie sembrada (ha)",
#     y = "Superficie cosechada (ha)"
#   ) +
#   theme_minimal()
# datos |>
#   ggplot(aes(
#     x = superficie_sembrada_ha,
#     y = superficie_cosechada_ha,
#     size = produccion_tm     # <--- tamaño de la burbuja
#   )) +
#   geom_point(alpha = 0.6, color = "#00AFBB") +
#   labs(
#     title = "Relación entre superficie y producción",
#     x = "Superficie sembrada (ha)",
#     y = "Superficie cosechada (ha)",
#     size = "Producción (toneladas)"
#   ) +
#   theme_minimal()
library(ggplot2)
library(gganimate)
library(dplyr)

animacion <- datos |>
  ggplot(aes(
    x = superficie_sembrada_ha / 1000000,
    y = superficie_cosechada_ha / 1000000,
    size = produccion_tm,
    color = cultivo_nombre
  )) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(2, 12)) +
  labs(
    title = "Gráfico 3: Evolución de superficies y producción (Año: {closest_state})",
    subtitle = "Superficien en millones de ha.",
    x = "Superficie sembrada (ha)" ,
    y = "Superficie cosechada (ha)",
    size = "Producción (t)",
    color = "Cultivo"
  ) +
  theme_minimal() +
  transition_states(anio, transition_length = 1, state_length = 1)+
  theme(legend.position = "none")
animacion
```
```{r}
# Gráfico de puntos: rendimiento por departamento
# ggplot(datos, aes(x = reorder(departamento_nombre, -rendimiento_kgxha),
#                   y = rendimiento_kgxha,
#                   color = provincia_nombre)) +
#   geom_point(size = 4) +  # tamaño de los puntos
#   geom_hline(yintercept = max(datos$rendimiento_kgxha), linetype = "dashed", color = "red") +
#   labs(title = "Rendimiento de soja por departamento",
#        x = "Departamento",
#        y = "Rendimiento (kg/ha)",
#        color = "Provincia") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
# datos |>
#   filter(cultivo_nombre == "trigo") |>
#   ggplot(aes(
#     x = rendimiento_kgxha,
#     y = superficie_sembrada_ha / 1000000,
#     color = provincia_nombre,
#     label = departamento_nombre
#   )) +
#   geom_point(size = 1) + # cada punto = un departamento
#   geom_text(vjust = -0.7, size = 1) + # etiquetas con el nombre del departamento
#   labs(
#     title = "Relación entre rendimiento y superficie sembrada por departamento",
#     x = "Rendimiento (kg/ha)",
#     y = "Superficie sembrada (ha)",
#     color = "Provincia"
#   ) +
#   scale_fill_brewer(palette = "Dark2") +
#   theme(legend.position = "none")
```

```{r}
#| echo: false
#| message: false
#| warning: false
datos <- mutate(datos,
  etiqueta = paste0(
    "<b>Departamento:</b> ", departamento_nombre, "<br>",
    "<b>Año:</b> ", anio, "<br>",
    "<b>Provincia: </b>", provincia_nombre
  )
)

grafico <-
  datos |>
  filter(cultivo_nombre == "trigo") |>
  ggplot() +
  aes(
    title = "Gráfico 4: Relación entre Rendimiento y Poducción para los Departamentos.",
    subtitle = "Todas las provincias para toda la serie.",
    x = rendimiento_kgxha, 
    y = superficie_sembrada_ha / 1000000,
    color = provincia_nombre,
    label = departamento_nombre, text = etiqueta
  ) +
  geom_jitter(width = 0.5, height = 0, alpha = 0.5) +
  labs(
    x = "Rendimiento de Trigo (Kg / ha)", 
    y = "Superficie Sembrada (en millones de ha.)",
    color = "Provincia"
  ) + 
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = "none")

ggplotly(grafico, tooltip = "text")
```